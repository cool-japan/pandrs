# PandRS クレートバージョンアップ計画

## 現在のバージョンと新バージョン

| クレート       | 現在のバージョン | 新バージョン     | 変更の規模    | 優先度 |
|--------------|--------------|--------------|------------|-------|
| num-traits   | 0.2.14       | 0.2.19       | パッチ       | 低    |
| chrono       | 0.4.19       | 0.4.40       | マイナー     | 中    |
| serde        | 1.0.x        | 1.0.219      | パッチ       | 低    |
| serde_json   | 1.0.64       | 1.0.114+     | パッチ       | 低    |
| thiserror    | 1.0.24       | 2.0.12       | メジャー     | 高    |
| csv          | 1.1.6        | 1.3.1        | マイナー     | 中    |
| rand         | 0.8.4        | 0.9.0        | マイナー     | 高    |
| chrono-tz    | 0.6.1        | 0.10.3       | マイナー     | 高    |
| textplots    | 0.6.3        | 0.8.7        | マイナー     | 中    |
| rayon        | 1.5.1        | 1.9.0        | マイナー     | 中    |
| regex        | 1.5.4        | 1.10.2       | マイナー     | 中    |
| lazy_static  | 1.4.0        | 1.5.0        | パッチ       | 低    |
| tempfile     | (確認必要)    | 3.8.1        | (確認必要)   | 低    |
| parquet      | (確認必要)    | 54.3.1       | メジャー     | 高    |
| arrow        | (確認必要)    | 54.3.1       | メジャー     | 高    |

## アップデート戦略

このバージョンアップ計画では、リスクを最小限に抑えるために段階的なアプローチを採用します。各ステージでは、関連するクレートをグループ化し、互換性テストを行いながら進めます。

### ステージ1: 低リスクアップデート（パッチバージョン）

以下のクレートは後方互換性が高く、アップデートによるリスクが低いと考えられます：

- **num-traits**: 0.2.14 → 0.2.19
  - 数値型のトレイト定義の小さな改善とバグ修正
  - APIの変更はなく、内部実装の最適化が主

- **serde**: 1.0.x → 1.0.219
  - シリアライズ/デシリアライズの機能改善とバグ修正
  - 後方互換性が維持されているパッチバージョンアップ
  
- **serde_json**: 1.0.64 → 1.0.114+
  - JSONパースの性能改善とバグ修正
  - 後方互換性が維持されているパッチバージョンアップ

- **lazy_static**: 1.4.0 → 1.5.0
  - 小さな機能改善とバグ修正
  - 既存コードへの影響は最小限と予想

- **tempfile**: (現バージョン確認) → 3.8.1
  - 一時ファイル処理の改善
  - 主にセキュリティ修正とパフォーマンス改善

**実装手順**:
1. Cargo.tomlの依存関係を一つずつ更新
2. 各更新後に`cargo build`を実行して構文エラーがないことを確認
3. 単体テストとサンプルコードでの動作確認
4. すべてのテストが通ることを確認

### ステージ2: 中リスクアップデート（マイナーバージョン）

以下のクレートはAPIに小さな変更がある可能性がありますが、大規模なコード変更は不要と予想されます：

- **chrono**: 0.4.19 → 0.4.40
  - 日付と時間処理の機能改善
  - タイムゾーン処理とフォーマット機能の強化
  - 互換性を維持した上での内部実装最適化

- **csv**: 1.1.6 → 1.3.1
  - CSVパースとライトの性能改善
  - フレキシブルなCSV読み込みオプションの追加
  - 既存APIとの互換性は維持

- **textplots**: 0.6.3 → 0.8.7
  - プロット機能の拡張と改善
  - 描画オプションの追加
  - 既存のプロット関数は互換性維持

- **rayon**: 1.5.1 → 1.9.0
  - 並列処理機能の大幅な性能改善
  - 新しい並列イテレータ機能の追加
  - 既存の並列処理コードとの互換性は維持

- **regex**: 1.5.4 → 1.10.2
  - 正規表現エンジンの性能改善
  - 新しいマッチングオプションの追加
  - 後方互換性は基本的に維持

**実装手順**:
1. 各クレートの変更履歴を詳細に確認し、API変更点をドキュメント化
2. クレートを一つずつアップデート
3. コンパイルエラーが発生した場合は必要な修正を行う
4. 単体テストと統合テストで機能検証
5. 性能比較のためにベンチマークを実行

### ステージ3: 高リスクアップデート（メジャーバージョン）

以下のクレートはメジャーバージョンアップまたは大きな変更を含むため、慎重なアップデートとコード修正が必要です：

- **thiserror**: 1.0.24 → 2.0.12
  - エラー処理のAPIに大きな変更
  - 既存のエラー型定義の修正が必要
  - 新しいエラーハンドリング機能の活用

- **rand**: 0.8.4 → 0.9.0
  - 乱数生成アルゴリズムとAPIの変更
  - シード設定と分布関数の変更点を対応
  - 性能向上と新機能の活用

- **chrono-tz**: 0.6.1 → 0.10.3
  - タイムゾーンデータベースの大幅更新
  - タイムゾーン処理APIの変更
  - chrono本体との統合方法の変更

- **parquet**: (現バージョン確認) → 54.3.1
  - Arrow統合の大幅な変更
  - スキーマ定義とデータ型の変更
  - 読み書き処理の最適化と新API

- **arrow**: (現バージョン確認) → 54.3.1
  - 新しいメモリレイアウトとデータ型
  - パフォーマンス最適化
  - 新しいAPIとデータ処理パイプライン

**実装手順**:
1. 各クレートの移行ガイドと変更履歴を詳細に分析
2. 影響するコード領域を特定し、必要な変更をドキュメント化
3. テスト環境で一つずつアップデートし、必要なコード修正を実施
4. 単体テスト、統合テスト、エンドツーエンドテストでの検証
5. 性能とメモリ使用の変化をベンチマークで検証

## クレート別詳細分析と対応計画

### thiserror (1.0.24 → 2.0.12)

**主な変更点**:
- エラー型定義のマクロ構文の変更
- エラーハンドリングトレイトの実装の変更
- 新しいエラー表示と伝播オプションの追加

**対応方針**:
1. 現在のエラー型定義（`error.rs`）を特定
2. 新しいマクロ構文への移行計画を作成
3. テストケースを更新して新しいエラー処理を検証

### rand (0.8.4 → 0.9.0)

**主な変更点**:
- 乱数生成ディストリビューションのAPI変更
- シードと状態管理の改善
- 並列対応の乱数生成機能の強化

**対応方針**:
1. 現在のrandクレート使用箇所を特定（サンプルデータ生成など）
2. API変更に合わせたコード修正
3. 安全性とパフォーマンス向上のための最適化

### chrono-tz (0.6.1 → 0.10.3)

**主な変更点**:
- タイムゾーンデータベースの大幅更新
- `chrono`クレートとの統合インターフェースの変更
- タイムゾーン変換と表示機能の拡張

**対応方針**:
1. 時系列データ処理部分（`temporal`モジュール）での使用箇所を特定
2. 新しいタイムゾーンAPIへの移行
3. 最新のタイムゾーンデータを活用した機能強化

### parquet & arrow (→ 54.3.1)

**主な変更点**:
- 統一された型システムとデータレイアウト
- メモリ効率とパフォーマンスの向上
- 新しいシリアライズ/デシリアライズAPI

**対応方針**:
1. 現在のParquet/Arrow統合コードを特定
2. 新APIへの移行計画を作成
3. データ変換と入出力処理のテスト強化

## テスト戦略

各アップデートステージにおいて以下のテストを実施します：

1. **単体テスト**:
   - 既存のすべての単体テストが通ることを確認
   - 新機能や変更部分の単体テストを追加

2. **統合テスト**:
   - サンプルコードの実行確認
   - 実際のデータセットでの処理検証

3. **性能テスト**:
   - ベンチマークを実行し、性能の変化を検証
   - メモリ使用量の変化を測定

4. **Python連携テスト**:
   - Pythonバインディングが正常に動作することを確認
   - pandasとの相互変換テスト

## ロールバック計画

万が一、アップデートによって重大な問題が発生した場合のロールバック手順：

1. 前回の安定バージョンのCargo.tomlをGitから復元
2. `cargo clean`を実行してビルドキャッシュをクリア
3. 依存関係を再度取得して再ビルド
4. 緊急修正が必要な場合は、問題のあるクレートの使用部分を特定し対処

## まとめと推奨アクション

このバージョンアップ計画を以下のスケジュールで実施することを推奨します：

1. **Week 1**: ステージ1（低リスク）のアップデートとテスト
2. **Week 2**: ステージ2（中リスク）のアップデートとテスト
3. **Week 3-4**: ステージ3（高リスク）のアップデートと詳細テスト

各段階で以下のドキュメントを残すことを推奨します：
- 変更したファイルと行ったコード修正のリスト
- 発生した問題とその解決策
- 性能測定の結果と改善点

また、特に注意すべき点として：
- `thiserror` 2.0へのアップデートはエラー処理コード全体に影響する可能性が高い
- `parquet`と`arrow`のアップデートはファイル入出力処理全体の見直しが必要
- Python連携機能は型変換処理への影響が大きいため特に注意深くテストが必要

定期的なバージョンアップは技術的負債の蓄積を防ぎ、セキュリティとパフォーマンスを改善するために重要です。この計画に従って慎重に進めることで、最小限のリスクでPandRSをアップデートできると考えられます。