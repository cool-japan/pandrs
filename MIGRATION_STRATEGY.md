# DataFrame から OptimizedDataFrame への移行戦略

PandRSプロジェクトでは、従来の `DataFrame` から性能が向上した `OptimizedDataFrame` への移行を段階的に行います。この文書では、移行戦略と実施計画について説明します。

## 背景

PandRSプロジェクトでは、パフォーマンスと型安全性を向上させるために、列指向ストレージと型特化列を採用した `OptimizedDataFrame` を開発しました。`OptimizedDataFrame` は従来の `DataFrame` と比較して以下の利点があります：

- **高いパフォーマンス**: DataFrame作成、フィルタリング、集計処理などで2〜5倍の高速化
- **メモリ効率**: 列指向ストレージによるメモリ使用量の削減
- **型安全性**: 型特化列による型安全性の向上
- **文字列最適化**: 文字列プールによるメモリ使用量と処理時間の削減
- **Python連携**: 効率的なPython連携のための最適化

しかし、一度に完全移行を行うとリスクが高いため、段階的なアプローチを採用します。

## 移行戦略の概要

移行は以下の4つのフェーズに分けて実施します：

### フェーズ1: ファサードパターンの実装（現在）

- `OptimizedDataFrame` に、`DataFrame` に存在する未実装メソッド（`rename_columns`, `with_index` など）を追加実装
- 内部実装は `OptimizedDataFrame` の強みを活かす形で再実装
- 既存テストを `OptimizedDataFrame` 向けに複製し、両方のクラスでテストを実行
- ドキュメントとサンプルコードの更新開始

### フェーズ2: ラッパーアダプターの作成

- `DataFrame` をラッパークラスに変更し、内部で `OptimizedDataFrame` を使用するように修正
- 古いAPIを保持しつつ、処理を新実装に委譲
- フィーチャーフラグ（`#[cfg(feature = "optimized")]`）を活用して切り替え可能に
- パフォーマンステストと互換性テストの強化

### フェーズ3: 新旧API共存期間の設定

- 一定期間（3〜6ヶ月）は両方のAPIを維持
- 新しいコードでは `OptimizedDataFrame` の使用を推奨
- 古いAPIに非推奨（deprecated）警告を追加
- マイグレーションガイドとチュートリアルの提供

### フェーズ4: 完全移行

- 十分な移行期間後、古いAPIを完全に削除
- `OptimizedDataFrame` を `DataFrame` にリネーム（オプション）
- 完全に最適化された実装のみを提供
- パフォーマンスの最終評価

## 実施計画の詳細

### フェーズ1: ファサードパターンの実装（2〜3ヶ月）

#### タスク

1. **API互換性の確保**
   - `DataFrame` にある全てのパブリックメソッドのリスト作成
   - `OptimizedDataFrame` に未実装のメソッドの特定
   - 優先順位の決定（使用頻度、実装の複雑さなど）

2. **機能実装**
   - インデックス関連機能（`with_index`, `with_multi_index`, `set_column_as_index`）
   - 列操作機能（`rename_columns`）
   - その他の機能（優先度順）

3. **テスト拡充**
   - 既存の `DataFrame` テストを `OptimizedDataFrame` 用にも適用
   - 新しい機能に対するテストケースの追加
   - 継続的インテグレーション（CI）の設定

#### 成果物

- `OptimizedDataFrame` への追加実装されたメソッド
- 拡充されたテストスイート
- 初期APIドキュメントの更新

### フェーズ2: ラッパーアダプターの作成（1〜2ヶ月）

#### タスク

1. **ラッパーの設計と実装**
   - `DataFrame` を内部で `OptimizedDataFrame` を使用するように変更
   - メソッド呼び出しを委譲する実装
   - 型変換と互換性レイヤーの作成

2. **構成管理**
   - フィーチャーフラグによる切り替え機能の実装
   - コンパイル時の条件分岐設定

3. **パフォーマンステスト**
   - 移行前後のパフォーマンス比較
   - ボトルネックの特定と最適化

#### 成果物

- `DataFrame` ラッパー実装
- フィーチャーフラグ対応ビルドシステム
- パフォーマンスベンチマークレポート

### フェーズ3: 新旧API共存期間の設定（3〜6ヶ月）

#### タスク

1. **非推奨化と警告**
   - 古いAPIに非推奨属性の追加
   - 警告メッセージの改善（移行方法の案内）

2. **ドキュメントとガイド**
   - 包括的な移行ガイドの作成
   - チュートリアルとサンプルコードの完全更新
   - APIリファレンスの更新

3. **ユーザーフィードバック**
   - フィードバックの収集と分析
   - 必要に応じた調整とバグ修正

#### 成果物

- 非推奨警告が追加された古いAPI
- 移行ガイドとチュートリアル
- 更新されたAPIリファレンス

### フェーズ4: 完全移行（1ヶ月）

#### タスク

1. **コードクリーンアップ**
   - 古い実装コードの削除
   - 非推奨APIの完全削除

2. **リネーム（オプション）**
   - `OptimizedDataFrame` を `DataFrame` にリネーム検討
   - 関連するドキュメントとコードの更新

3. **最終評価**
   - パフォーマンス最終評価
   - コードベースの品質評価

#### 成果物

- クリーンな最適化コードベース
- 最終パフォーマンス評価レポート
- 移行完了のアナウンス

## テスト戦略

テストの混乱を避けるため、以下の戦略を採用します：

1. **並列テスト環境**
   - 両方の実装に対するテストを並行して実行
   - `#[cfg(feature = "optimized")]` を活用した条件付きテスト

2. **互換性テスト**
   - 同じ入力に対して両方の実装が同じ結果を返すことを確認
   - エッジケースの特定と対応

3. **パフォーマンステスト**
   - 定期的なベンチマーク実行
   - パフォーマンス回帰のモニタリング

## リスクと対策

1. **API互換性の問題**
   - リスク: 一部の高度なAPIで完全な互換性を保つことが難しい場合がある
   - 対策: 互換性が保てない場合は明確に文書化し、移行ガイドで代替手段を提供

2. **パフォーマンスの一時的低下**
   - リスク: ラッパーによる間接層の追加でパフォーマンスが一時的に低下する可能性
   - 対策: クリティカルパスでの最適化とインライン化

3. **ユーザーの混乱**
   - リスク: 並行する2つのAPIの存在がユーザーを混乱させる可能性
   - 対策: 明確なドキュメント、ガイド、非推奨警告の提供

## まとめ

この移行計画により、パフォーマンスと型安全性に優れた `OptimizedDataFrame` への段階的な移行が可能になります。各フェーズでの徹底したテストと段階的アプローチにより、リスクを最小限に抑えながら移行を進めることができます。

この計画は、プロジェクトの進捗や状況の変化に応じて調整され、更新されるものとします。